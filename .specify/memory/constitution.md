<!--
Sync Impact Report
==================
Version change: N/A → 1.0.0 (initial adoption)
Modified principles: N/A (template → complete constitution)
Added sections:
  - Preamble
  - Core Principles (10 principles: I-X)
  - Technology Stack (Frontend, Backend, Infrastructure)
  - CLAUDE.md Integration
  - Claude Code Integration (Specialized Agents, Skills)
  - Development Workflow (5 phases)
  - Code Quality Standards (Frontend/Backend examples)
  - Error Handling
  - Security Checklist
  - Git & Version Control
  - Deployment Strategy
  - Governance
  - References
Removed sections: N/A (template was empty)
Templates requiring updates:
  - .specify/templates/plan-template.md ✅ (principles aligned)
  - .specify/templates/spec-template.md ✅ (scope aligned)
  - .specify/templates/tasks-template.md ✅ (task types aligned)
Follow-up TODOs: None
-->

# Todo App - Phase 2 Constitution

**Project**: Todo Full-Stack Web Application
**Phase**: Phase 2 - Full-Stack Web Application
**Version**: 1.0.0
**Ratified**: 2025-12-25
**Status**: Active

---

## Preamble

This constitution establishes the foundational principles for Phase 2 of the Todo App project. Phase 2 transforms the console application into a modern, multi-user web application with persistent storage using Next.js 16+, FastAPI, SQLModel, and Neon Serverless PostgreSQL.

All implementation in this phase must follow spec-driven development methodology. No code shall be written manually; all code must be generated by Claude Code from specifications. Ratification follows specification, never precedes it.

---

## Core Principles

### I. Spec-Driven Development

**Description**: Every feature must be fully specified before implementation begins.

**Rules**:
- Write a complete Markdown specification for every feature before any implementation
- Specifications must include user stories, acceptance criteria, and success metrics
- No code may be written manually - all implementation must be generated by Claude Code from specifications
- Refine specifications until Claude Code generates correct output
- All specifications must be version controlled under `/specs` directory
- Reference specs with `@specs/features/feature-name.md` notation

**Rationale**: Spec-driven development ensures clear requirements, maintainable code, and alignment between intent and implementation.

---

### II. Monorepo Architecture

**Description**: Frontend and backend coexist in a single repository with clear boundaries.

**Structure**:
```
/frontend    - Next.js 16+ application (App Router)
/backend     - Python FastAPI application
/specs       - All specifications organized by type
  /features  - Feature specifications
  /api       - API endpoint specifications
  /database  - Database schema specifications
  /ui        - UI component specifications
```

**Rules**:
- Each service (frontend/backend) must be independently deployable
- Shared types and contracts must be documented in `/specs/api`
- No circular dependencies between frontend and backend
- Each service has its own CLAUDE.md with specific guidelines
- Environment variables manage service communication

**Rationale**: Monorepo enables coordinated changes while maintaining clear service boundaries.

---

### III. Test-First Development

**Description**: Tests are written and approved before implementation begins.

**Rules**:
- For every feature, write acceptance tests first
- Tests must fail initially (Red phase)
- Implement until tests pass (Green phase)
- Refactor while keeping tests green
- No feature is complete without passing tests
- Minimum test coverage: 80% for backend, 70% for frontend

**Test Pyramid**:
- Backend: Unit tests, integration tests, API contract tests
- Frontend: Component tests, integration tests, E2E tests (critical paths)

**Rationale**: Test-first development catches bugs early and ensures requirements are met.

---

### IV. Authentication & Authorization First

**Description**: Security is foundational, not an afterthought. Better Auth with JWT tokens is mandatory.

**Rules**:
- Implement Better Auth with JWT tokens from the start
- All API endpoints must validate JWT tokens
- User isolation: users only access their own data
- Store secrets in environment variables, never in code
- Use HTTPS in production
- Implement rate limiting on authentication endpoints

**Authentication Flow**:
1. User logs in on Frontend → Better Auth creates session and issues JWT token
2. Frontend makes API call → Includes JWT token in Authorization: Bearer <token> header
3. Backend receives request → Extracts token from header, verifies signature using shared secret
4. Backend identifies user → Decodes token to get user ID
5. Backend filters data → Returns only tasks belonging to that user

**Security Standards**:
- Passwords: bcrypt hashing with salt
- JWT: Signed with BETTER_AUTH_SECRET, 7-day expiration
- Sessions: Secure, HttpOnly cookies
- CORS: Whitelist frontend origin only

**Rationale**: Security by design prevents vulnerabilities and data breaches.

---

### V. API-First Design

**Description**: Design and document API contracts before implementation.

**API Endpoints (Phase 2)**:
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/{user_id}/tasks | List all tasks |
| POST | /api/{user_id}/tasks | Create a new task |
| GET | /api/{user_id}/tasks/{id} | Get task details |
| PUT | /api/{user_id}/tasks/{id} | Update a task |
| DELETE | /api/{user_id}/tasks/{id} | Delete a task |
| PATCH | /api/{user_id}/tasks/{id}/complete | Toggle completion |

**Rules**:
- All API endpoints must be documented in `/specs/api/endpoints.md`
- Follow RESTful conventions strictly
- Return appropriate HTTP status codes (200, 201, 400, 401, 404, 500)
- Use consistent error response format
- All endpoints require JWT authentication

**API Response Format**:
```json
{
  "success": true,
  "data": { ... },
  "error": null
}
```

**Error Response Format**:
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message"
  }
}
```

**Rationale**: API-first design ensures frontend and backend can be developed in parallel.

---

### VI. Database-First Schema Design

**Description**: Define database schema before implementing models or queries.

**Database Schema (Phase 2)**:

**users table** (managed by Better Auth):
- id: string (primary key)
- email: string (unique)
- name: string
- created_at: timestamp

**tasks table**:
- id: integer (primary key, auto-increment)
- user_id: string (foreign key → users.id)
- title: string (not null, max 200 characters)
- description: text (nullable, max 1000 characters)
- completed: boolean (default false)
- created_at: timestamp
- updated_at: timestamp

**Rules**:
- Document complete schema in `/specs/database/schema.md`
- Use SQLModel for ORM (combines SQLAlchemy + Pydantic)
- Apply migrations for all schema changes
- Index frequently queried fields (user_id, completed)
- Enforce foreign key constraints
- Use UUIDs for user IDs (from Better Auth), integers for task IDs

**Schema Standards**:
- Every table has: `created_at`, `updated_at` timestamps
- Consistent naming: snake_case for columns
- Document all relationships and constraints
- Add indexes on: tasks.user_id, tasks.completed

**Rationale**: Schema-first design prevents data integrity issues and migration headaches.

---

### VII. Modern UI/UX Standards

**Description**: Build beautiful, accessible, responsive user interfaces.

**Tech Stack**:
- **Framework**: Next.js 16+ with App Router
- **Language**: TypeScript 5.0+
- **Styling**: Tailwind CSS
- **Components**: Shadcn/ui (Radix UI primitives)
- **Animation**: Framer Motion
- **HTTP Client**: Axios (MANDATORY - NO fetch for API calls)
- **State**: Zustand (MANDATORY - NO React Context for complex state)

**Rules**:
- Mobile-first responsive design
- Dark mode support from day one
- Accessibility: WCAG 2.1 Level AA compliance
- Loading states for all async operations
- Error boundaries for graceful error handling
- Optimistic UI updates for better UX

**Performance Standards**:
- First Contentful Paint (FCP) < 1.5s
- Time to Interactive (TTI) < 3.5s
- Lighthouse score > 85

**Component Structure**:
```
/components
  /ui          # Shadcn/ui base components
  /task        # Task-specific components
    TaskList.tsx
    TaskItem.tsx
    TaskForm.tsx
    TaskCard.tsx
  /auth        # Authentication components
  /layout      # Layout components
```

**Rationale**: Modern UI/UX standards create delightful user experiences.

---

### VIII. Observability & Debugging

**Description**: Applications must be observable and debuggable in production.

**Rules**:
- Structured logging (JSON format)
- Log levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Include request IDs in all logs for tracing
- Log all authentication attempts (success/failure)
- Log all database errors
- Never log sensitive data (passwords, tokens, JWTs)

**Monitoring Focus**:
- API response times
- Error rates by endpoint
- Database query performance
- Authentication failures

**Rationale**: Observability enables rapid debugging and performance optimization.

---

### IX. Documentation & Knowledge Capture

**Description**: Every decision and architectural choice must be documented.

**Documentation Requirements**:
1. **Prompt History Records (PHRs)**: Record significant user interactions
2. **Architecture Decision Records (ADRs)**: Document architectural decisions
3. **README.md**: Setup instructions, tech stack, deployment guide
4. **API Documentation**: Complete endpoint documentation with examples
5. **Inline Comments**: Explain complex logic, not obvious code

**PHR Creation**:
- Route to appropriate subfolder: `history/prompts/{feature-name}/`
- Include: ID, title, user prompt, assistant response, files changed

**Rationale**: Documentation preserves knowledge and accelerates onboarding.

---

### X. Progressive Enhancement

**Description**: Build incrementally from simple to complex.

**Phase 2 Sub-Phases**:
1. **Phase 2A**: Basic CRUD (View, Add tasks)
2. **Phase 2B**: Update, Delete, Mark Complete
3. **Phase 2C**: User Authentication with Better Auth

**Rules**:
- Deliver working software at each sub-phase
- Each increment must be deployable
- Don't build features that aren't in the spec
- Keep it simple (YAGNI - You Aren't Gonna Need It)

**Rationale**: Progressive enhancement delivers value early and reduces risk.

---

## Technology Stack

### Frontend
- **Framework**: Next.js 16+ (App Router, Server Components, Server Actions)
- **Language**: TypeScript 5.0+
- **Styling**: Tailwind CSS
- **Components**: Shadcn/ui (Radix UI primitives)
- **Animation**: Framer Motion
- **Forms**: React Hook Form + Zod validation
- **HTTP Client**: Axios (REQUIRED for API calls)
- **State**: Zustand (REQUIRED for state management)

### Backend
- **Framework**: FastAPI 0.115+
- **Language**: Python 3.13+
- **ORM**: SQLModel 0.0.24+ (SQLAlchemy 2.0 + Pydantic 2.0)
- **Database**: Neon Serverless PostgreSQL
- **Authentication**: Better Auth (JWT tokens)
- **Validation**: Pydantic 2.0
- **Testing**: pytest 8.0+, httpx (for API tests)
- **Package Manager**: UV (fast Python package manager)

### Infrastructure
- **Frontend Hosting**: Vercel
- **Backend Hosting**: Vercel (Python runtime) or Railway
- **Database**: Neon Serverless PostgreSQL (free tier)
- **Version Control**: Git + GitHub

---

## CLAUDE.md Integration

**READ BEFORE ANY WORK**:

1. **Read CLAUDE.md files in order:**
   - `CLAUDE.md` (root) - Master project rules and agent/skill references
   - `frontend/CLAUDE.md` - Frontend-specific guidelines
   - `backend/CLAUDE.md` - Backend-specific guidelines

2. **Use Context7 MCP BEFORE implementation:**
   - Fetch latest FastAPI documentation for patterns
   - Fetch latest SQLModel documentation for ORM
   - Fetch latest Next.js documentation for App Router
   - Fetch latest Tailwind CSS documentation for styling

3. **Reference Skills for Setup Tasks:**
   - Check `.claude/skills/` before any initialization

**Coupling**: All CLAUDE.md files reference this constitution. This constitution references all CLAUDE.md files. They work together as a unified system.

---

## Claude Code Integration

### Specialized Agents

Use these agents via `@agent-name` for domain-specific tasks:

| Agent | Trigger | Purpose |
|-------|---------|---------|
| **Backend API Builder** | `@backend-api-builder` | FastAPI development: endpoints, services, middleware, testing |
| **Frontend UI Builder** | `@frontend-ui-builder` | Next.js development: components, pages, hooks, animations |
| **Database Designer** | `@database-designer` | PostgreSQL schema, SQLModel models, migrations |

### Skills Reference

Use these skills for setup and configuration guidance:

| Skill | Purpose |
|-------|---------|
| **FastAPI Setup** | Initialize FastAPI project with UV |
| **Next.js Setup** | Initialize Next.js 16+ with App Router |
| **Shadcn/ui Setup** | Configure component library |
| **Neon DB Setup** | Configure PostgreSQL database |
| **Better Auth** | JWT authentication for frontend and backend |

---

## Development Workflow

### 1. Specification Phase
- Write or update feature specification in `/specs/features/`
- Define user stories with acceptance criteria
- Document API contracts in `/specs/api/`
- Define database schema in `/specs/database/`
- Get user approval before proceeding

### 2. Planning Phase
- Research technical approach
- Design architecture
- Identify dependencies
- Create implementation plan

### 3. Task Generation
- Break down plan into testable tasks
- Prioritize tasks by dependency order
- Each task must be independently verifiable

### 4. Implementation Phase
- Execute tasks in order
- Generate code using Claude Code from specs
- Write tests first (Red phase)
- Implement until tests pass (Green phase)

### 5. Review Phase
- Run all tests
- Check code quality
- Verify spec compliance

---

## Code Quality Standards

### Frontend (TypeScript)

```typescript
// ✅ GOOD: Clear, typed, readable
interface Task {
  id: number;
  title: string;
  description?: string;
  completed: boolean;
  userId: string;
  createdAt: Date;
  updatedAt: Date;
}

export async function createTask(userId: string, title: string, description?: string): Promise<Task> {
  const response = await api.post(`/api/${userId}/tasks`, { title, description });
  return response.data;
}
```

```typescript
// ❌ BAD: No types, unclear, error-prone
export async function createTask(id, title) {
  const res = await fetch("/api/tasks", { method: "POST", body: JSON.stringify({ title }) });
  return res.json();
}
```

### Backend (Python)

```python
# ✅ GOOD: Clear, typed, validated
from sqlmodel import SQLModel, Field
from datetime import datetime
from typing import Optional

class Task(SQLModel, table=True):
    __tablename__ = "tasks"

    id: int | None = Field(default=None, primary_key=True, nullable=False)
    user_id: str = Field(foreign_key="users.id", index=True)
    title: str = Field(max_length=200)
    description: str | None = Field(default=None, max_length=1000)
    completed: bool = Field(default=False)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
```

```python
# ❌ BAD: No validation, no types, unsafe
def create_task(user_id, title):
    db.execute(f"INSERT INTO tasks (user_id, title) VALUES ('{user_id}', '{title}')")
    # SQL injection vulnerability!
```

---

## Error Handling

### Frontend
- Use Error Boundaries for React component errors
- Show user-friendly error messages
- Log errors to console in development

### Backend
- Use FastAPI HTTPException for API errors
- Return consistent error format
- Log all errors with context
- Never expose internal errors to clients

**Error Response Format**:
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Invalid or expired token",
    "details": {}
  }
}
```

---

## Security Checklist

- [ ] All API endpoints validate JWT tokens
- [ ] User data is isolated by user_id (from JWT)
- [ ] SQL injection prevented (use SQLModel ORM)
- [ ] XSS prevented (React auto-escapes)
- [ ] Rate limiting on auth endpoints
- [ ] HTTPS in production
- [ ] Environment variables for secrets
- [ ] No secrets in git repository
- [ ] CORS configured correctly (frontend origin only)
- [ ] Input validation on all endpoints (Pydantic models)

---

## Git & Version Control

### Branch Strategy
- `main` - production-ready code
- `feature/[feature-name]` - feature branches
- Create PR for all changes
- Squash commits on merge

### Commit Messages
```
feat: add user authentication with Better Auth
fix: resolve task deletion bug
docs: update API endpoint documentation
refactor: simplify task service logic
test: add integration tests for task API
```

Format: `type: description`
Types: feat, fix, docs, refactor, test, chore

---

## Deployment Strategy

### Frontend (Vercel)
- Connect GitHub repository
- Auto-deploy on push to main
- Environment variables via Vercel dashboard

### Backend (Vercel Python or Railway)
- Set up Python runtime
- Configure DATABASE_URL
- Set BETTER_AUTH_SECRET

### Database (Neon)
- Create project and database
- Copy connection string to backend env
- Run migrations on startup

---

## Governance

### Constitution Authority
- This constitution supersedes all other practices
- All code reviews must verify compliance
- Violations must be justified and documented
- Amendments require user approval and documentation

### Change Management
- Constitution changes require new version number
- Document rationale for all amendments
- Update CLAUDE.md to reflect changes

### Versioning Policy
- **MAJOR**: Backward incompatible governance/principle removals or redefinitions
- **MINOR**: New principle/section added or materially expanded guidance
- **PATCH**: Clarifications, wording, typo fixes, non-semantic refinements

### Compliance Review
- All PRs/reviews must verify constitution compliance
- Each feature must demonstrate alignment with core principles
- Complex deviations require documented justification

---

## References

- [Hackathon II Documentation](./Hackathon%20II%20-%20Todo%20Spec-Driven%20Development%20(1).md)
- [Next.js Documentation](https://nextjs.org/docs)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com/)
- [Better Auth Documentation](https://www.better-auth.com/)
- [Shadcn/ui Components](https://ui.shadcn.com/)
- [Tailwind CSS](https://tailwindcss.com/docs)

---

**Version**: 1.0.0 | **Ratified**: 2025-12-25 | **Last Amended**: 2025-12-25
